---
- name: Update WSUS Server
  hosts: all
  gather_facts: no
  become: true
  become_method: runas
  become_user: "{{ ansible_user }}"
  vars:
    ansible_become_method: runas
    ansible_become_flags: logon_type=new_credentials logon_flags=netcredentials_only


  tasks:
  - name: Run PowerShell Script to approve updates on WSUS
    win_shell: |
      $wsus = Get-WsusServer -Name "CLANDIG3-WSUS" -PortNumber 8530
      $updates = $wsus.GetUpdates() | Where-Object {$_.IsApproved -eq $false}
      foreach ($update in $updates) {
        $update.Approve("AllComputers")
      }
    register: shell_output

  - name: Show output
    debug:
      var: shell_output.stdout_lines